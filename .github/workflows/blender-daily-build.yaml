name: Blender daily build

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_blender:
    name: Build Blender
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Checkout Blender source code from Blender official repository
        run: |
          mkdir -p blender-build
          cd blender-build
          git clone --branch v4.5.0 --depth 1 https://projects.blender.org/blender/blender.git
      - name: Apply patch
        run: |
          cd blender-build/blender
          git apply ../../my_change.patch
      - name: Install initial packages
        run: |
          sudo apt update
          sudo apt install python3 git git-lfs
      - name: Install basic building environment
        run: |
          cd blender-build/blender
          ./build_files/build_environment/install_linux_packages.py
      - name: Download libraries
        run: |
          cd blender-build/blender
          ./build_files/utils/make_update.py --use-linux-libraries
      - name: Build Blender
        run: |
          cd blender-build/blender
          make update
          make
      - name: Test Blender Binary
        run: |
          ./blender-build/build_linux/bin/blender --background --factory-startup -noaudio
      - name: Compress Blender for the release
        run: |
          mkdir release
          cp -r blender-build/build_linux/bin release/blender
          cd release
          tar Jcf blender.tar.xz blender
          rm -rf blender
      - name: Create MD5 checksum file
        run: |
          cd release
          md5sum blender.tar.xz > blender.tar.xz.md5
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: blender-build-${{ steps.date.outputs.date }}
          name: Blender Build ${{ steps.date.outputs.date }}
          draft: false
          prerelease: false
          files: |
            release/blender.tar.xz
            release/blender.tar.xz.md5
